import React, { useState, useCallback, useRef, useEffect } from 'react';\nimport { Upload, X, Pause, Play, Trash2, FileText, Image, Film, Music } from 'lucide-react';\n\ninterface FileUploadProps {\n  onUploadComplete?: (files: any[]) => void;\n  maxFiles?: number;\n  maxSize?: number;\n  allowedTypes?: string[];\n  allowedExtensions?: string[];\n  className?: string;\n}\n\ninterface UploadItem {\n  id: string;\n  file: File;\n  progress: number;\n  status: 'pending' | 'uploading' | 'completed' | 'error' | 'paused';\n  error?: string;\n  preview?: string;\n}\n\nexport const AdvancedFileUpload: React.FC<FileUploadProps> = ({\n  onUploadComplete,\n  maxFiles = 10,\n  maxSize = 50 * 1024 * 1024, // 50MB\n  allowedTypes = [],\n  allowedExtensions = [],\n  className = ''\n}) => {\n  const [files, setFiles] = useState<UploadItem[]>([]);\n  const [isDragOver, setIsDragOver] = useState(false);\n  const [uploadQueue, setUploadQueue] = useState<string[]>([]);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const websocketRef = useRef<WebSocket | null>(null);\n\n  // Initialize WebSocket for real-time progress updates\n  useEffect(() => {\n    const wsUrl = process.env.REACT_APP_WS_URL || 'ws://localhost:3001';\n    websocketRef.current = new WebSocket(wsUrl);\n\n    websocketRef.current.onmessage = (event) => {\n      const data = JSON.parse(event.data);\n      if (data.type === 'upload-progress') {\n        updateFileProgress(data.progress);\n      }\n    };\n\n    return () => {\n      websocketRef.current?.close();\n    };\n  }, []);\n\n  const updateFileProgress = useCallback((progressData: any) => {\n    setFiles(prev => prev.map(file => \n      file.id === progressData.fileId \n        ? { ...file, ...progressData }\n        : file\n    ));\n  }, []);\n\n  const validateFile = useCallback((file: File): string | null => {\n    // Check file size\n    if (file.size > maxSize) {\n      return `File size exceeds maximum allowed size of ${Math.round(maxSize / 1024 / 1024)}MB`;\n    }\n\n    // Check MIME type\n    if (allowedTypes.length > 0 && !allowedTypes.includes(file.type)) {\n      return `File type ${file.type} is not allowed`;\n    }\n\n    // Check file extension\n    const fileExtension = '.' + file.name.split('.').pop()?.toLowerCase();\n    if (allowedExtensions.length > 0 && !allowedExtensions.includes(fileExtension)) {\n      return `File extension ${fileExtension} is not allowed`;\n    }\n\n    return null;\n  }, [maxSize, allowedTypes, allowedExtensions]);\n\n  const generatePreview = useCallback((file: File): Promise<string | null> => {\n    return new Promise((resolve) => {\n      if (file.type.startsWith('image/')) {\n        const reader = new FileReader();\n        reader.onload = (e) => resolve(e.target?.result as string);\n        reader.readAsDataURL(file);\n      } else if (file.type.startsWith('text/')) {\n        const reader = new FileReader();\n        reader.onload = (e) => {\n          const text = e.target?.result as string;\n          resolve(text.substring(0, 100) + (text.length > 100 ? '...' : ''));\n        };\n        reader.readAsText(file);\n      } else {\n        resolve(null);\n      }\n    });\n  }, []);\n\n  const handleFiles = useCallback(async (fileList: FileList) => {\n    const newFiles: UploadItem[] = [];\n    \n    for (let i = 0; i < fileList.length && files.length + newFiles.length < maxFiles; i++) {\n      const file = fileList[i];\n      const error = validateFile(file);\n      \n      if (error) {\n        newFiles.push({\n          id: Math.random().toString(36).substr(2, 9),\n          file,\n          progress: 0,\n          status: 'error',\n          error\n        });\n      } else {\n        const preview = await generatePreview(file);\n        newFiles.push({\n          id: Math.random().toString(36).substr(2, 9),\n          file,\n          progress: 0,\n          status: 'pending',\n          preview\n        });\n      }\n    }\n    \n    setFiles(prev => [...prev, ...newFiles]);\n    \n    // Start upload for new files\n    newFiles.forEach(fileItem => {\n      if (fileItem.status === 'pending') {\n        uploadFile(fileItem);\n      }\n    });\n  }, [files.length, maxFiles, validateFile, generatePreview]);\n\n  const uploadFile = useCallback(async (fileItem: UploadItem) => {\n    setFiles(prev => prev.map(f => \n      f.id === fileItem.id ? { ...f, status: 'uploading' } : f\n    ));\n\n    const formData = new FormData();\n    formData.append('file', fileItem.file);\n    formData.append('maxSize', maxSize.toString());\n    formData.append('allowedTypes', JSON.stringify(allowedTypes));\n    formData.append('allowedExtensions', JSON.stringify(allowedExtensions));\n\n    try {\n      const response = await fetch('/api/upload/single', {\n        method: 'POST',\n        body: formData,\n        headers: {\n          'Authorization': `Bearer ${localStorage.getItem('token')}`\n        }\n      });\n\n      const result = await response.json();\n      \n      if (response.ok) {\n        setFiles(prev => prev.map(f => \n          f.id === fileItem.id ? { ...f, status: 'completed', progress: 100 } : f\n        ));\n      } else {\n        setFiles(prev => prev.map(f => \n          f.id === fileItem.id ? { ...f, status: 'error', error: result.error } : f\n        ));\n      }\n    } catch (error) {\n      setFiles(prev => prev.map(f => \n        f.id === fileItem.id ? { \n          ...f, \n          status: 'error', \n          error: error instanceof Error ? error.message : 'Upload failed' \n        } : f\n      ));\n    }\n  }, [maxSize, allowedTypes, allowedExtensions]);\n\n  const handleDragOver = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(true);\n  }, []);\n\n  const handleDragLeave = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(false);\n  }, []);\n\n  const handleDrop = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(false);\n    handleFiles(e.dataTransfer.files);\n  }, [handleFiles]);\n\n  const handleFileSelect = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files) {\n      handleFiles(e.target.files);\n    }\n  }, [handleFiles]);\n\n  const removeFile = useCallback((id: string) => {\n    setFiles(prev => prev.filter(f => f.id !== id));\n  }, []);\n\n  const pauseUpload = useCallback((id: string) => {\n    fetch(`/api/upload/pause/${id}`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${localStorage.getItem('token')}`\n      }\n    });\n    setFiles(prev => prev.map(f => \n      f.id === id ? { ...f, status: 'paused' } : f\n    ));\n  }, []);\n\n  const resumeUpload = useCallback((id: string) => {\n    fetch(`/api/upload/resume/${id}`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${localStorage.getItem('token')}`\n      }\n    });\n    setFiles(prev => prev.map(f => \n      f.id === id ? { ...f, status: 'uploading' } : f\n    ));\n  }, []);\n\n  const getFileIcon = (mimeType: string) => {\n    if (mimeType.startsWith('image/')) return <Image className=\"w-5 h-5\" />;\n    if (mimeType.startsWith('video/')) return <Film className=\"w-5 h-5\" />;\n    if (mimeType.startsWith('audio/')) return <Music className=\"w-5 h-5\" />;\n    return <FileText className=\"w-5 h-5\" />;\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n  const completedFiles = files.filter(f => f.status === 'completed');\n  useEffect(() => {\n    if (completedFiles.length > 0 && onUploadComplete) {\n      onUploadComplete(completedFiles);\n    }\n  }, [completedFiles, onUploadComplete]);\n\n  return (\n    <div className={`w-full max-w-4xl mx-auto p-6 ${className}`}>\n      {/* Drop Zone */}\n      <div\n        className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${\n          isDragOver \n            ? 'border-blue-500 bg-blue-50' \n            : 'border-gray-300 hover:border-gray-400'\n        }`}\n        onDragOver={handleDragOver}\n        onDragLeave={handleDragLeave}\n        onDrop={handleDrop}\n      >\n        <Upload className=\"w-12 h-12 mx-auto mb-4 text-gray-400\" />\n        <p className=\"text-lg font-medium text-gray-700 mb-2\">\n          Drag and drop files here, or click to select\n        </p>\n        <p className=\"text-sm text-gray-500 mb-4\">\n          Maximum {maxFiles} files, up to {Math.round(maxSize / 1024 / 1024)}MB each\n        </p>\n        <input\n          ref={fileInputRef}\n          type=\"file\"\n          multiple\n          onChange={handleFileSelect}\n          className=\"hidden\"\n          accept={allowedExtensions.join(',')}\n        />\n        <button\n          onClick={() => fileInputRef.current?.click()}\n          className=\"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\n        >\n          Select Files\n        </button>\n      </div>\n\n      {/* File List */}\n      {files.length > 0 && (\n        <div className=\"mt-6 space-y-3\">\n          <h3 className=\"text-lg font-medium text-gray-900\">Upload Queue</h3>\n          {files.map((fileItem) => (\n            <div\n              key={fileItem.id}\n              className=\"bg-white border rounded-lg p-4 shadow-sm\"\n            >\n              <div className=\"flex items-center justify-between mb-2\">\n                <div className=\"flex items-center space-x-3 flex-1\">\n                  {getFileIcon(fileItem.file.type)}\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"text-sm font-medium text-gray-900 truncate\">\n                      {fileItem.file.name}\n                    </p>\n                    <p className=\"text-xs text-gray-500\">\n                      {formatFileSize(fileItem.file.size)}\n                    </p>\n                  </div>\n                </div>\n                <div className=\"flex items-center space-x-2\">\n                  {fileItem.status === 'uploading' && (\n                    <button\n                      onClick={() => pauseUpload(fileItem.id)}\n                      className=\"p-1 text-gray-500 hover:text-gray-700\"\n                      title=\"Pause\"\n                    >\n                      <Pause className=\"w-4 h-4\" />\n                    </button>\n                  )}\n                  {fileItem.status === 'paused' && (\n                    <button\n                      onClick={() => resumeUpload(fileItem.id)}\n                      className=\"p-1 text-gray-500 hover:text-gray-700\"\n                      title=\"Resume\"\n                    >\n                      <Play className=\"w-4 h-4\" />\n                    </button>\n                  )}\n                  <button\n                    onClick={() => removeFile(fileItem.id)}\n                    className=\"p-1 text-red-500 hover:text-red-700\"\n                    title=\"Remove\"\n                  >\n                    <Trash2 className=\"w-4 h-4\" />\n                  </button>\n                </div>\n              </div>\n\n              {/* Progress Bar */}\n              {fileItem.status !== 'error' && fileItem.status !== 'completed' && (\n                <div className=\"mt-2\">\n                  <div className=\"flex justify-between text-xs text-gray-600 mb-1\">\n                    <span>{fileItem.status}</span>\n                    <span>{fileItem.progress}%</span>\n                  </div>\n                  <div className=\"w-full bg-gray-200 rounded-full h-2\">\n                    <div\n                      className=\"bg-blue-600 h-2 rounded-full transition-all duration-300\"\n                      style={{ width: `${fileItem.progress}%` }}\n                    />\n                  </div>\n                </div>\n              )}\n\n              {/* Error Message */}\n              {fileItem.status === 'error' && (\n                <div className=\"mt-2 text-sm text-red-600\">\n                  {fileItem.error}\n                </div>\n              )}\n\n              {/* Preview */}\n              {fileItem.preview && fileItem.status === 'completed' && (\n                <div className=\"mt-2\">\n                  {fileItem.file.type.startsWith('image/') ? (\n                    <img\n                      src={fileItem.preview}\n                      alt={fileItem.file.name}\n                      className=\"h-16 w-16 object-cover rounded\"\n                    />\n                  ) : (\n                    <p className=\"text-xs text-gray-600 italic\">{fileItem.preview}</p>\n                  )}\n                </div>\n              )}\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n};
