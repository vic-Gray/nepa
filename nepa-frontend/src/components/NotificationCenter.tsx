import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { io, Socket } from 'socket.io-client';\nimport { Bell, X, Check, Settings, Trash2, Volume2, VolumeX, Filter } from 'lucide-react';\n\ninterface Notification {\n  id: string;\n  type: 'INFO' | 'SUCCESS' | 'WARNING' | 'ERROR' | 'BILL_CREATED' | 'BILL_OVERDUE' | 'PAYMENT_CONFIRMED' | 'SYSTEM_ALERT';\n  title: string;\n  message: string;\n  data?: any;\n  priority: 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT';\n  category?: 'BILLING' | 'PAYMENT' | 'SYSTEM' | 'USER' | 'SECURITY';\n  actionUrl?: string;\n  actionText?: string;\n  isRead: boolean;\n  createdAt: string;\n  expiresAt?: string;\n  sound?: string;\n  icon?: string;\n}\n\ninterface NotificationPreferences {\n  email: boolean;\n  sms: boolean;\n  push: boolean;\n  inApp: boolean;\n  soundEnabled: boolean;\n  desktopNotifications: boolean;\n  quietHours?: {\n    enabled: boolean;\n    start: string;\n    end: string;\n  };\n  categories?: {\n    [key: string]: boolean;\n  };\n}\n\ninterface NotificationCenterProps {\n  userId: string;\n  token: string;\n  className?: string;\n}\n\nexport const NotificationCenter: React.FC<NotificationCenterProps> = ({\n  userId,\n  token,\n  className = ''\n}) => {\n  const [notifications, setNotifications] = useState<Notification[]>([]);\n  const [unreadCount, setUnreadCount] = useState(0);\n  const [isOpen, setIsOpen] = useState(false);\n  const [isLoading, setIsLoading] = useState(false);\n  const [preferences, setPreferences] = useState<NotificationPreferences | null>(null);\n  const [filter, setFilter] = useState<string>('all');\n  const [showSettings, setShowSettings] = useState(false);\n  const socketRef = useRef<Socket | null>(null);\n  const audioRef = useRef<HTMLAudioElement | null>(null);\n\n  // Initialize WebSocket connection\n  useEffect(() => {\n    const socket = io(process.env.REACT_APP_WS_URL || 'ws://localhost:3001', {\n      auth: {\n        token,\n        userId\n      }\n    });\n\n    socketRef.current = socket;\n\n    socket.on('connect', () => {\n      console.log('Connected to notification server');\n      socket.emit('authenticate', { token, userId });\n    });\n\n    socket.on('notification', (notification: Notification) => {\n      setNotifications(prev => [notification, ...prev]);\n      setUnreadCount(prev => prev + 1);\n      \n      // Play sound if enabled\n      if (preferences?.soundEnabled && notification.sound) {\n        playNotificationSound(notification.sound);\n      }\n      \n      // Show browser notification if enabled\n      if (preferences?.desktopNotifications) {\n        showBrowserNotification(notification);\n      }\n    });\n\n    socket.on('notifications', (newNotifications: Notification[]) => {\n      setNotifications(prev => [...newNotifications, ...prev]);\n      const unreadNew = newNotifications.filter(n => !n.isRead).length;\n      setUnreadCount(prev => prev + unreadNew);\n    });\n\n    socket.on('unread_count', (count: number) => {\n      setUnreadCount(count);\n    });\n\n    socket.on('error', (error: any) => {\n      console.error('Socket error:', error);\n    });\n\n    socket.on('disconnect', () => {\n      console.log('Disconnected from notification server');\n    });\n\n    return () => {\n      socket.disconnect();\n    };\n  }, [userId, token, preferences]);\n\n  // Load initial notifications\n  useEffect(() => {\n    loadNotifications();\n    loadPreferences();\n  }, [userId]);\n\n  // Request notification permission\n  useEffect(() => {\n    if ('Notification' in window && Notification.permission === 'default') {\n      Notification.requestPermission();\n    }\n  }, []);\n\n  const loadNotifications = async () => {\n    setIsLoading(true);\n    try {\n      const response = await fetch(`/api/notifications/${userId}`, {\n        headers: {\n          'Authorization': `Bearer ${token}`\n        }\n      });\n      \n      if (response.ok) {\n        const data = await response.json();\n        setNotifications(data.notifications || []);\n        setUnreadCount(data.unreadCount || 0);\n      }\n    } catch (error) {\n      console.error('Failed to load notifications:', error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const loadPreferences = async () => {\n    try {\n      const response = await fetch(`/api/notifications/preferences/${userId}`, {\n        headers: {\n          'Authorization': `Bearer ${token}`\n        }\n      });\n      \n      if (response.ok) {\n        const data = await response.json();\n        setPreferences(data);\n      }\n    } catch (error) {\n      console.error('Failed to load preferences:', error);\n    }\n  };\n\n  const markAsRead = useCallback(async (notificationId: string) => {\n    try {\n      socketRef.current?.emit('mark_read', notificationId);\n      \n      setNotifications(prev => \n        prev.map(n => n.id === notificationId ? { ...n, isRead: true } : n)\n      );\n      setUnreadCount(prev => Math.max(0, prev - 1));\n    } catch (error) {\n      console.error('Failed to mark as read:', error);\n    }\n  }, []);\n\n  const markAllAsRead = useCallback(async () => {\n    try {\n      socketRef.current?.emit('mark_all_read');\n      \n      setNotifications(prev => \n        prev.map(n => ({ ...n, isRead: true }))\n      );\n      setUnreadCount(0);\n    } catch (error) {\n      console.error('Failed to mark all as read:', error);\n    }\n  }, []);\n\n  const deleteNotification = useCallback(async (notificationId: string) => {\n    try {\n      socketRef.current?.emit('delete_notification', notificationId);\n      \n      setNotifications(prev => {\n        const notification = prev.find(n => n.id === notificationId);\n        if (notification && !notification.isRead) {\n          setUnreadCount(count => Math.max(0, count - 1));\n        }\n        return prev.filter(n => n.id !== notificationId);\n      });\n    } catch (error) {\n      console.error('Failed to delete notification:', error);\n    }\n  }, []);\n\n  const updatePreferences = useCallback(async (newPreferences: Partial<NotificationPreferences>) => {\n    try {\n      const response = await fetch(`/api/notifications/preferences/${userId}`, {\n        method: 'PUT',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`\n        },\n        body: JSON.stringify(newPreferences)\n      });\n      \n      if (response.ok) {\n        const data = await response.json();\n        setPreferences(data);\n      }\n    } catch (error) {\n      console.error('Failed to update preferences:', error);\n    }\n  }, [userId, token]);\n\n  const playNotificationSound = useCallback((soundType: string) => {\n    if (!audioRef.current) {\n      audioRef.current = new Audio();\n    }\n    \n    // Map sound types to audio files\n    const soundMap: { [key: string]: string } = {\n      'default': '/sounds/notification-default.mp3',\n      'urgent': '/sounds/notification-urgent.mp3',\n      'success': '/sounds/notification-success.mp3',\n      'warning': '/sounds/notification-warning.mp3',\n      'error': '/sounds/notification-error.mp3'\n    };\n    \n    const soundFile = soundMap[soundType] || soundMap['default'];\n    audioRef.current.src = soundFile;\n    audioRef.current.play().catch(() => {\n      // Ignore autoplay errors\n    });\n  }, []);\n\n  const showBrowserNotification = useCallback((notification: Notification) => {\n    if ('Notification' in window && Notification.permission === 'granted') {\n      const browserNotification = new Notification(notification.title, {\n        body: notification.message,\n        icon: notification.icon || '/favicon.ico',\n        tag: notification.id,\n        requireInteraction: notification.priority === 'URGENT',\n        actions: notification.actionText ? [\n          {\n            action: 'open',\n            title: notification.actionText\n          }\n        ] : []\n      });\n\n      browserNotification.onclick = () => {\n        window.focus();\n        if (notification.actionUrl) {\n          window.open(notification.actionUrl, '_blank');\n        }\n        browserNotification.close();\n      };\n\n      // Auto-close after 5 seconds for non-urgent notifications\n      if (notification.priority !== 'URGENT') {\n        setTimeout(() => {\n          browserNotification.close();\n        }, 5000);\n      }\n    }\n  }, []);\n\n  const getPriorityColor = (priority: string) => {\n    switch (priority) {\n      case 'URGENT': return 'border-red-500 bg-red-50';\n      case 'HIGH': return 'border-orange-500 bg-orange-50';\n      case 'MEDIUM': return 'border-yellow-500 bg-yellow-50';\n      case 'LOW': return 'border-blue-500 bg-blue-50';\n      default: return 'border-gray-300 bg-gray-50';\n    }\n  };\n\n  const getTypeIcon = (type: string) => {\n    switch (type) {\n      case 'SUCCESS': return 'âœ…';\n      case 'WARNING': return 'âš ï¸';\n      case 'ERROR': return 'âŒ';\n      case 'BILL_CREATED': return 'ðŸ“„';\n      case 'BILL_OVERDUE': return 'â°';\n      case 'PAYMENT_CONFIRMED': return 'ðŸ’°';\n      case 'SYSTEM_ALERT': return 'ðŸ””';\n      default: return 'â„¹ï¸';\n    }\n  };\n\n  const filteredNotifications = notifications.filter(notification => {\n    if (filter === 'all') return true;\n    if (filter === 'unread') return !notification.isRead;\n    if (filter === 'category') return notification.category === filter;\n    return notification.priority === filter;\n  });\n\n  return (\n    <div className={`relative ${className}`}>\n      {/* Notification Bell */}\n      <button\n        onClick={() => setIsOpen(!isOpen)}\n        className=\"relative p-2 text-gray-600 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg\"\n        aria-label={`Notifications ${unreadCount > 0 ? `(${unreadCount} unread)` : ''}`}\n      >\n        <Bell className=\"w-6 h-6\" />\n        {unreadCount > 0 && (\n          <span className=\"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center\">\n            {unreadCount > 99 ? '99+' : unreadCount}\n          </span>\n        )}\n      </button>\n\n      {/* Notification Dropdown */}\n      {isOpen && (\n        <div className=\"absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-xl border border-gray-200 z-50 max-h-96 flex flex-col\">\n          {/* Header */}\n          <div className=\"flex items-center justify-between p-4 border-b border-gray-200\">\n            <h3 className=\"font-semibold text-gray-900\">Notifications</h3>\n            <div className=\"flex items-center space-x-2\">\n              <button\n                onClick={() => setShowSettings(!showSettings)}\n                className=\"p-1 text-gray-500 hover:text-gray-700 rounded\"\n                aria-label=\"Settings\"\n              >\n                <Settings className=\"w-4 h-4\" />\n              </button>\n              <button\n                onClick={() => setIsOpen(false)}\n                className=\"p-1 text-gray-500 hover:text-gray-700 rounded\"\n                aria-label=\"Close\"\n              >\n                <X className=\"w-4 h-4\" />\n              </button>\n            </div>\n          </div>\n\n          {/* Settings Panel */}\n          {showSettings && preferences && (\n            <div className=\"p-4 border-b border-gray-200 bg-gray-50\">\n              <h4 className=\"font-medium text-gray-900 mb-3\">Settings</h4>\n              <div className=\"space-y-2\">\n                <label className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-gray-700\">Sound</span>\n                  <button\n                    onClick={() => updatePreferences({ soundEnabled: !preferences.soundEnabled })}\n                    className={`p-1 rounded ${preferences.soundEnabled ? 'text-blue-600' : 'text-gray-400'}`}\n                  >\n                    {preferences.soundEnabled ? <Volume2 className=\"w-4 h-4\" /> : <VolumeX className=\"w-4 h-4\" />}\n                  </button>\n                </label>\n                <label className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-gray-700\">Desktop Notifications</span>\n                  <input\n                    type=\"checkbox\"\n                    checked={preferences.desktopNotifications}\n                    onChange={(e) => updatePreferences({ desktopNotifications: e.target.checked })}\n                    className=\"rounded\"\n                  />\n                </label>\n              </div>\n            </div>\n          )}\n\n          {/* Filter Tabs */}\n          <div className=\"flex items-center space-x-1 p-2 border-b border-gray-200\">\n            <button\n              onClick={() => setFilter('all')}\n              className={`px-3 py-1 text-sm rounded ${filter === 'all' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:text-gray-900'}`}\n            >\n              All\n            </button>\n            <button\n              onClick={() => setFilter('unread')}\n              className={`px-3 py-1 text-sm rounded ${filter === 'unread' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:text-gray-900'}`}\n            >\n              Unread\n            </button>\n            {unreadCount > 0 && (\n              <button\n                onClick={markAllAsRead}\n                className=\"ml-auto px-3 py-1 text-sm text-blue-600 hover:text-blue-700\"\n              >\n                Mark all read\n              </button>\n            )}\n          </div>\n\n          {/* Notifications List */}\n          <div className=\"flex-1 overflow-y-auto\">\n            {isLoading ? (\n              <div className=\"flex items-center justify-center p-8\">\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600\"></div>\n              </div>\n            ) : filteredNotifications.length === 0 ? (\n              <div className=\"p-8 text-center text-gray-500\">\n                <Bell className=\"w-12 h-12 mx-auto mb-2 text-gray-300\" />\n                <p>No notifications</p>\n              </div>\n            ) : (\n              <div className=\"divide-y divide-gray-200\">\n                {filteredNotifications.map((notification) => (\n                  <div\n                    key={notification.id}\n                    className={`p-4 hover:bg-gray-50 transition-colors ${\n                      !notification.isRead ? 'bg-blue-50' : ''\n                    } ${getPriorityColor(notification.priority)}`}\n                  >\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center space-x-2 mb-1\">\n                          <span className=\"text-lg\">{getTypeIcon(notification.type)}</span>\n                          <h4 className={`text-sm font-medium text-gray-900 ${\n                            !notification.isRead ? 'font-semibold' : ''\n                          }`}>\n                            {notification.title}\n                          </h4>\n                        </div>\n                        <p className=\"text-sm text-gray-600 mb-2\">{notification.message}</p>\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"text-xs text-gray-500\">\n                            {new Date(notification.createdAt).toLocaleString()}\n                          </span>\n                          {notification.actionUrl && (\n                            <a\n                              href={notification.actionUrl}\n                              target=\"_blank\"\n                              rel=\"noopener noreferrer\"\n                              className=\"text-xs text-blue-600 hover:text-blue-700\"\n                              onClick={(e) => e.stopPropagation()}\n                            >\n                              {notification.actionText || 'View'}\n                            </a>\n                          )}\n                        </div>\n                      </div>\n                      <div className=\"flex items-center space-x-1 ml-2\">\n                        {!notification.isRead && (\n                          <button\n                            onClick={() => markAsRead(notification.id)}\n                            className=\"p-1 text-gray-500 hover:text-green-600 rounded\"\n                            aria-label=\"Mark as read\"\n                          >\n                            <Check className=\"w-4 h-4\" />\n                          </button>\n                        )}\n                        <button\n                          onClick={() => deleteNotification(notification.id)}\n                          className=\"p-1 text-gray-500 hover:text-red-600 rounded\"\n                          aria-label=\"Delete\"\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n\n      {/* Hidden audio element */}\n      <audio ref={audioRef} preload=\"auto\" />\n    </div>\n  );\n};
