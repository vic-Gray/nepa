import React, { useState, useRef, useEffect } from 'react';\nimport { optimizeImage } from '../utils/performance';\n\ninterface LazyImageProps {\n  src: string;\n  alt: string;\n  width?: number;\n  height?: number;\n  className?: string;\n  placeholder?: string;\n  quality?: number;\n  format?: 'webp' | 'avif' | 'jpeg' | 'png';\n}\n\nexport const LazyImage: React.FC<LazyImageProps> = ({\n  src,\n  alt,\n  width,\n  height,\n  className = '',\n  placeholder,\n  quality = 80,\n  format = 'webp',\n}) => {\n  const [isLoaded, setIsLoaded] = useState(false);\n  const [isInView, setIsInView] = useState(false);\n  const [hasError, setHasError] = useState(false);\n  const imgRef = useRef<HTMLImageElement>(null);\n  const observerRef = useRef<IntersectionObserver | null>(null);\n\n  useEffect(() => {\n    const img = imgRef.current;\n    if (!img) return;\n\n    // Create intersection observer for lazy loading\n    observerRef.current = new IntersectionObserver(\n      (entries) => {\n        entries.forEach((entry) => {\n          if (entry.isIntersecting) {\n            setIsInView(true);\n            \n            // Start loading the image\n            const optimizedSrc = optimizeImage(src, {\n              width,\n              height,\n              quality,\n              format,\n            });\n            \n            img.src = optimizedSrc;\n          }\n        });\n      },\n      {\n        rootMargin: '50px', // Start loading 50px before it comes into view\n        threshold: 0.1,\n      }\n    );\n\n    observerRef.current.observe(img);\n\n    return () => {\n      if (observerRef.current) {\n        observerRef.current.disconnect();\n      }\n    };\n  }, [src, width, height, quality, format]);\n\n  const handleLoad = () => {\n    setIsLoaded(true);\n  };\n\n  const handleError = () => {\n    setHasError(true);\n  };\n\n  return (\n    <div className={`relative overflow-hidden ${className}`}>\n      {/* Placeholder */}\n      {!isLoaded && (\n        <div\n          className=\"absolute inset-0 bg-gray-200 dark:bg-gray-700 animate-pulse\"\n          style={{\n            width: width ? `${width}px` : '100%',\n            height: height ? `${height}px` : '200px',\n          }}\n        >\n          {placeholder && (\n            <div className=\"absolute inset-0 flex items-center justify-center text-gray-400 dark:text-gray-500\">\n              <span className=\"text-4xl\">{placeholder}</span>\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Actual Image */}\n      <img\n        ref={imgRef}\n        alt={alt}\n        width={width}\n        height={height}\n        onLoad={handleLoad}\n        onError={handleError}\n        className={`transition-opacity duration-300 ${\n          isLoaded ? 'opacity-100' : 'opacity-0'\n        } ${hasError ? 'hidden' : ''}`}\n        loading=\"lazy\"\n        decoding=\"async\"\n        style={{\n          objectFit: 'cover',\n        }}\n      />\n\n      {/* Error State */}\n      {hasError && (\n        <div className=\"absolute inset-0 flex items-center justify-center bg-gray-100 dark:bg-gray-800\">\n          <div className=\"text-center\">\n            <div className=\"text-4xl text-gray-400 dark:text-gray-500 mb-2\">⚠️</div>\n            <p className=\"text-sm text-gray-600 dark:text-gray-400\">Failed to load image</p>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};
