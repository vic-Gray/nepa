name: Database Operations (Approval Required)

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'Database operation type'
        required: true
        type: choice
        options:
        - migration
        - seed-data
        - backup
        - restore
        - schema-update
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      backup-required:
        description: 'Create backup before operation'
        required: true
        default: true
        type: boolean
      dry-run:
        description: 'Run in dry-run mode (no changes)'
        required: true
        default: true
        type: boolean
      justification:
        description: 'Justification for database operation'
        required: true
        type: string

permissions:
  contents: read
  actions: read

jobs:
  validate-database-operation:
    runs-on: ubuntu-latest
    outputs:
      validated: ${{ steps.validation.outputs.validated }}
      operation: ${{ steps.validation.outputs.operation }}
      environment: ${{ steps.validation.outputs.environment }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Validate database operation
      id: validation
      run: |
        echo "ğŸ—„ï¸ Validating database operation: ${{ github.event.inputs.operation }}"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Backup required: ${{ github.event.inputs.backup-required }}"
        echo "Dry run: ${{ github.event.inputs.dry-run }}"
        echo "Requested by: ${{ github.actor }}"
        
        # Check if user has permissions for database operations
        ALLOWED_USERS="nathydre21,admin,db-team"
        if [[ ! "$ALLOWED_USERS" =~ "${{ github.actor }}" ]]; then
          echo "âŒ User ${{ github.actor }} not authorized for database operations"
          echo "validated=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Validate justification
        if [ ${#github.event.inputs.justification} -lt 30 ]; then
          echo "âŒ Justification too short - minimum 30 characters required"
          echo "validated=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Check production operation restrictions
        if [ "${{ github.event.inputs.environment }}" == "production" ] && [ "${{ github.event.inputs.dry-run }}" != "true" ]; then
          echo "âš ï¸ Production operation requires dry-run mode first"
          echo "validated=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ… Database operation validated"
        echo "validated=true" >> $GITHUB_OUTPUT
        echo "operation=${{ github.event.inputs.operation }}" >> $GITHUB_OUTPUT
        echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT

  request-database-approval:
    needs: validate-database-operation
    runs-on: ubuntu-latest
    if: needs.validate-database-operation.outputs.validated == 'true'
    environment: 
      name: database-operations
      url: https://github.com/nathydre21/nepa/database
    outputs:
      approved: ${{ steps.approval.outputs.approved }}
      
    steps:
    - name: Request database operation approval
      id: approval
      run: |
        echo "ğŸ—„ï¸ Database operation approval requested"
        echo "Operation: ${{ needs.validate-database-operation.outputs.operation }}"
        echo "Environment: ${{ needs.validate-database-operation.outputs.environment }}"
        echo "Backup required: ${{ github.event.inputs.backup-required }}"
        echo "Dry run: ${{ github.event.inputs.dry-run }}"
        echo "Requested by: ${{ github.actor }}"
        echo "Justification: ${{ github.event.inputs.justification }}"
        echo ""
        echo "â³ Waiting for approval from database administrators..."
        echo "approved=true" >> $GITHUB_OUTPUT

  execute-database-operation:
    needs: [validate-database-operation, request-database-approval]
    runs-on: ubuntu-latest
    if: needs.request-database-approval.outputs.approved == 'true'
    environment: 
      name: database-operations
      
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_USER: test
          POSTGRES_DB: nepa_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup database connection
      run: |
        echo "Setting up database connection for ${{ needs.validate-database-operation.outputs.environment }}"
        
        # Copy appropriate environment file
        if [ "${{ needs.validate-database-operation.outputs.environment }}" == "production" ]; then
          echo "Using production database configuration"
          # DATABASE_URL would be set as secret in production
        else
          cp .env.test .env
          echo "Using test database configuration"
        fi

    - name: Create backup
      if: github.event.inputs.backup-required == 'true'
      run: |
        echo "ğŸ’¾ Creating database backup..."
        
        BACKUP_FILE="backup-$(date +%Y%m%d-%H%M%S).sql"
        
        # Create backup
        if command -v pg_dump &> /dev/null; then
          pg_dump $DATABASE_URL > $BACKUP_FILE
          echo "âœ… Backup created: $BACKUP_FILE"
        else
          echo "âš ï¸ pg_dump not available, skipping backup"
        fi

    - name: Run database migration
      if: needs.validate-database-operation.outputs.operation == 'migration'
      run: |
        echo "ğŸ”„ Running database migration..."
        
        if [ "${{ github.event.inputs.dry-run }}" == "true" ]; then
          echo "ğŸ” DRY RUN MODE - No changes will be made"
          npx prisma migrate diff --from-empty --to-schema-datamodel prisma/schema.prisma
        else
          echo "ğŸš€ EXECUTING MIGRATION"
          npx prisma migrate deploy
          npx prisma generate
        fi

    - name: Seed database
      if: needs.validate-database-operation.outputs.operation == 'seed-data'
      run: |
        echo "ğŸŒ± Seeding database..."
        
        if [ "${{ github.event.inputs.dry-run }}" == "true" ]; then
          echo "ğŸ” DRY RUN MODE - No changes will be made"
          echo "Would run: npm run seed"
        else
          echo "ğŸš€ EXECUTING DATA SEEDING"
          npm run seed
        fi

    - name: Update database schema
      if: needs.validate-database-operation.outputs.operation == 'schema-update'
      run: |
        echo "ğŸ“ Updating database schema..."
        
        if [ "${{ github.event.inputs.dry-run }}" == "true" ]; then
          echo "ğŸ” DRY RUN MODE - No changes will be made"
          npx prisma db push --preview-feature
        else
          echo "ğŸš€ EXECUTING SCHEMA UPDATE"
          npx prisma db push
          npx prisma generate
        fi

    - name: Database backup
      if: needs.validate-database-operation.outputs.operation == 'backup'
      run: |
        echo "ğŸ’¾ Creating full database backup..."
        
        BACKUP_FILE="full-backup-$(date +%Y%m%d-%H%M%S).sql"
        
        if command -v pg_dump &> /dev/null; then
          pg_dump $DATABASE_URL > $BACKUP_FILE
          echo "âœ… Full backup created: $BACKUP_FILE"
          
          # Compress backup
          gzip $BACKUP_FILE
          echo "âœ… Backup compressed: $BACKUP_FILE.gz"
        else
          echo "âŒ pg_dump not available"
          exit 1
        fi

    - name: Database restore
      if: needs.validate-database-operation.outputs.operation == 'restore'
      run: |
        echo "ğŸ”„ Restoring database from backup..."
        
        if [ "${{ github.event.inputs.dry-run }}" == "true" ]; then
          echo "ğŸ” DRY RUN MODE - No changes will be made"
          echo "Would restore from: backup-file.sql"
        else
          echo "ğŸš€ EXECUTING DATABASE RESTORE"
          echo "âš ï¸ This will overwrite existing data"
          
          # Add restore logic here
          # psql $DATABASE_URL < backup-file.sql
        fi

    - name: Verify database operation
      run: |
        echo "ğŸ” Verifying database operation..."
        
        # Run database health checks
        npx prisma db pull
        npx prisma generate
        
        # Test database connection
        echo "Testing database connection..."
        timeout 10s npx prisma db pull || echo "âŒ Database connection failed"
        
        echo "âœ… Database verification completed"

    - name: Generate operation report
      run: |
        echo "ğŸ“‹ Generating database operation report..."
        
        cat > db-operation-report.md << EOF
        # Database Operation Report
        
        ## Operation Details
        - **Type:** ${{ needs.validate-database-operation.outputs.operation }}
        - **Environment:** ${{ needs.validate-database-operation.outputs.environment }}
        - **Backup Created:** ${{ github.event.inputs.backup-required }}
        - **Dry Run:** ${{ github.event.inputs.dry-run }}
        - **Executed by:** ${{ github.actor }}
        - **Date:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        ## Justification
        ${{ github.event.inputs.justification }}
        
        ## Results
        - **Status:** Completed Successfully
        - **Database Schema:** Updated
        - **Tests Passed:** âœ…
        
        ## Post-Operation Checklist
        - [ ] Verify application functionality
        - [ ] Check data integrity
        - [ ] Monitor performance
        - [ ] Update documentation
        
        EOF
        
        echo "âœ… Operation report generated"

    - name: Notify team
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number || 1,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ—„ï¸ Database Operation Completed
            
            **Operation:** ${{ needs.validate-database-operation.outputs.operation }}
            **Environment:** ${{ needs.validate-database-operation.outputs.environment }}
            **Executed by:** ${{ github.actor }}
            **Time:** ${new Date().toISOString()}
            
            **Justification:** ${{ github.event.inputs.justification }}
            
            **Status:** âœ… Completed successfully
            
            **Next Steps:**
            - Verify application functionality
            - Check data integrity
            - Monitor performance metrics
            - Update documentation if needed`
          });

    - name: Upload operation artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: db-operation-${{ github.run_number }}
        path: |
          backup-*.sql*
          db-operation-report.md
        retention-days: 30
