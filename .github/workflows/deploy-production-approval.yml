name: Production Deployment (Approval Required)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      notes:
        description: 'Deployment notes or changes'
        required: false
        type: string

permissions:
  contents: read
  deployments: write
  actions: read

jobs:
  pre-deployment-checks:
    runs-on: ubuntu-latest
    outputs:
      can-deploy: ${{ steps.checks.outputs.can-deploy }}
      version: ${{ steps.checks.outputs.version }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run pre-deployment checks
      id: checks
      run: |
        echo "Running pre-deployment checks..."
        
        # Check if tests are passing
        npm run test:ci -- --watchAll=false
        if [ $? -ne 0 ]; then
          echo "âŒ Tests are failing - cannot deploy"
          echo "can-deploy=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Check if build is successful
        npm run build
        if [ $? -ne 0 ]; then
          echo "âŒ Build failed - cannot deploy"
          echo "can-deploy=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Check security audit
        npm audit --audit-level=moderate
        if [ $? -ne 0 ]; then
          echo "âš ï¸ Security vulnerabilities found - review required"
          echo "can-deploy=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ… All pre-deployment checks passed"
        echo "can-deploy=true" >> $GITHUB_OUTPUT
        echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

  request-approval:
    needs: pre-deployment-checks
    runs-on: ubuntu-latest
    if: needs.pre-deployment-checks.outputs.can-deploy == 'true'
    environment: 
      name: ${{ github.event.inputs.environment }}
      url: https://nepa.example.com
    outputs:
      approved: ${{ steps.approval.outputs.approved }}
      
    steps:
    - name: Request deployment approval
      id: approval
      run: |
        echo "ğŸš¨ Deployment approval requested for ${{ github.event.inputs.environment }}"
        echo "Version: ${{ github.event.inputs.version }}"
        echo "Requested by: ${{ github.actor }}"
        echo "Notes: ${{ github.event.inputs.notes }}"
        echo ""
        echo "â³ Waiting for approval from authorized personnel..."
        echo "approved=true" >> $GITHUB_OUTPUT

  deploy:
    needs: [pre-deployment-checks, request-approval]
    runs-on: ubuntu-latest
    if: needs.request-approval.outputs.approved == 'true'
    environment: 
      name: ${{ github.event.inputs.environment }}
      url: https://nepa.example.com
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build

    - name: Create deployment artifact
      run: |
        tar -czf nepa-${{ needs.pre-deployment-checks.outputs.version }}.tar.gz dist/
        echo "Artifact created: nepa-${{ needs.pre-deployment-checks.outputs.version }}.tar.gz"

    - name: Deploy to ${{ github.event.inputs.environment }}
      run: |
        echo "ğŸš€ Deploying version ${{ needs.pre-deployment-checks.outputs.version }} to ${{ github.event.inputs.environment }}"
        echo "Deployment initiated by: ${{ github.actor }}"
        echo "Deployment notes: ${{ github.event.inputs.notes }}"
        
        # Add your actual deployment commands here
        # Examples:
        # docker build -t nepa:${{ needs.pre-deployment-checks.outputs.version }} .
        # docker push nepa:${{ needs.pre-deployment-checks.outputs.version }}
        # kubectl set image deployment/nepa nepa=nepa:${{ needs.pre-deployment-checks.outputs.version }}
        
        echo "âœ… Deployment completed successfully"

    - name: Post-deployment verification
      run: |
        echo "ğŸ” Running post-deployment verification..."
        
        # Add health checks here
        # curl -f https://nepa.example.com/health || exit 1
        
        echo "âœ… Post-deployment verification passed"

    - name: Notify deployment success
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number || 1,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸš€ Deployment Successful
            
            **Environment:** ${{ github.event.inputs.environment }}
            **Version:** ${{ needs.pre-deployment-checks.outputs.version }}
            **Deployed by:** ${{ github.actor }}
            **Time:** ${new Date().toISOString()}
            
            **Notes:** ${{ github.event.inputs.notes }}
            
            âœ… All systems operational`
          });

  rollback:
    needs: [pre-deployment-checks, request-approval, deploy]
    runs-on: ubuntu-latest
    if: failure() && needs.deploy.result == 'failure'
    environment: 
      name: ${{ github.event.inputs.environment }}
      
    steps:
    - name: Automatic rollback
      run: |
        echo "ğŸ”„ Deployment failed - initiating automatic rollback"
        echo "Rolling back version ${{ needs.pre-deployment-checks.outputs.version }} from ${{ github.event.inputs.environment }}"
        
        # Add rollback commands here
        # kubectl rollout undo deployment/nepa
        
        echo "âœ… Rollback completed"

    - name: Notify rollback
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number || 1,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ”„ Automatic Rollback
            
            **Environment:** ${{ github.event.inputs.environment }}
            **Failed Version:** ${{ needs.pre-deployment-checks.outputs.version }}
            **Time:** ${new Date().toISOString()}
            
            âŒ Deployment failed and was automatically rolled back`
          });
