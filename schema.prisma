generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BillStatus {
  PENDING
  PAID
  OVERDUE
}

enum PaymentStatus {
  SUCCESS
  FAILED
  PENDING
}

enum BlockchainNetwork {
  STELLAR
  ETHEREUM
  POLYGON
  BSC
  ARBITRUM
  OPTIMISM
}

enum CrossChainStatus {
  INITIATED
  SOURCE_CONFIRMED
  BRIDGE_PROCESSING
  DESTINATION_PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum TwoFactorMethod {
  NONE
  EMAIL
  SMS
  AUTHENTICATOR_APP
}

model User {
  id                String           @id @default(uuid())
  email             String           @unique
  username          String?          @unique
  passwordHash      String?          // For traditional auth
  name              String?
  phoneNumber       String?
  avatar            String?
  role              UserRole         @default(USER)
  status            UserStatus       @default(PENDING_VERIFICATION)
  walletAddress     String?          @unique // Stellar wallet address (legacy)
  isEmailVerified   Boolean          @default(false)
  isPhoneVerified   Boolean          @default(false)
  twoFactorEnabled  Boolean          @default(false)
  twoFactorMethod   TwoFactorMethod  @default(NONE)
  twoFactorSecret   String?          // For TOTP
  lastLoginAt       DateTime?
  loginAttempts     Int              @default(0)
  lockedUntil       DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  // Relations
  bills             Bill[]
  payments          Payment[]
  sessions          UserSession[]
  profiles          UserProfile[]
  notificationPreference NotificationPreference?
  notificationLogs       NotificationLog[]
  documents              Document[]
  reports                Report[]
  webhooks               Webhook[]
  auditLogs              AuditLog[]
  blockchainWallets      BlockchainWallet[]

  @@index([email])
  @@index([username])
  @@index([walletAddress])
  @@index([role])
  @@index([status])
}

model Utility {
  id        String   @id @default(uuid())
  name      String
  type      String
  provider  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  bills     Bill[]

  @@index([type])
}

model Bill {
  id        String     @id @default(uuid())
  amount    Decimal    @db.Decimal(10, 2)
  lateFee   Decimal    @default(0) @db.Decimal(10, 2)
  discount  Decimal    @default(0) @db.Decimal(10, 2)
  dueDate   DateTime
  status    BillStatus @default(PENDING)
  userId    String
  utilityId String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user      User       @relation(fields: [userId], references: [id])
  utility   Utility    @relation(fields: [utilityId], references: [id])
  payments  Payment[]

  @@index([userId])
  @@index([utilityId])
  @@index([status])
  @@index([dueDate])
}

model Coupon {
  id         String   @id @default(uuid())
  code       String   @unique
  amount     Decimal  @db.Decimal(10, 2)
  type       String   // 'PERCENTAGE' or 'FIXED'
  expiryDate DateTime
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Payment {
  id               String          @id @default(uuid())
  amount           Decimal         @db.Decimal(10, 2)
  method           String
  status           PaymentStatus   @default(PENDING)
  transactionId    String?         @unique
  billId           String
  userId           String
  network          BlockchainNetwork @default(STELLAR)
  transactionHash  String?         // Blockchain transaction hash
  gasUsed          String?         // Gas used for EVM transactions
  gasPrice         String?         // Gas price for EVM transactions
  fee              Decimal?        @db.Decimal(10, 2) // Network fee
  asset            String          @default("XLM") // Asset symbol (XLM, ETH, MATIC, etc.)
  confirmations    Int?            // Number of confirmations
  blockNumber      Int?            // Block number when confirmed
  blockHash        String?         // Block hash when confirmed
  fraudScore       Float?          // Fraud detection score
  fraudRiskLevel   FraudRiskLevel? // Risk level from fraud detection
  isBlocked        Boolean         @default(false) // Whether transaction was blocked by fraud detection
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  bill             Bill            @relation(fields: [billId], references: [id])
  user             User            @relation(fields: [userId], references: [id])
  fraudCase        FraudCase?       @relation(fields: [transactionId], references: [id])

  @@index([billId])
  @@index([userId])
  @@index([transactionId])
  @@index([transactionHash])
  @@index([network])
  @@index([status])
  @@index([fraudRiskLevel])
  @@index([isBlocked])
  @@index([createdAt])
}

model NotificationPreference {
  id        String   @id @default(uuid())
  userId    String   @unique
  email     Boolean  @default(true)
  sms       Boolean  @default(false)
  push      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id])
}

model NotificationLog {
  id           String   @id @default(uuid())
  userId       String
  type         String
  status       String
  message      String?
  scheduledFor DateTime?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id])
}

model Document {
  id           String   @id @default(uuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  path         String
  provider     String   // 'S3' or 'IPFS'
  userId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Report {
  id        String   @id @default(uuid())
  title     String
  type      String   // 'REVENUE', 'USER_GROWTH', 'BILLS'
  data      Json
  createdBy String
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [createdBy], references: [id])
}

model Webhook {
  id                String   @id @default(uuid())
  url               String
  events            String[] // Array of event types to listen to
  description       String?
  secret            String   // HMAC secret for webhook signing
  isActive          Boolean  @default(true)
  retryPolicy       String   @default("EXPONENTIAL") // EXPONENTIAL, LINEAR, FIXED
  maxRetries        Int      @default(3)
  retryDelaySeconds Int      @default(60)
  timeoutSeconds    Int      @default(30)
  headers           Json?    // Custom headers
  authType          String   @default("NONE") // NONE, API_KEY, BEARER_TOKEN, BASIC_AUTH, OAUTH2
  authCredentials   Json?    // Hashed authentication credentials
  securityConfig    Json?    // Security configuration (IP whitelist, rate limiting, etc.)
  userId            String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id])
  hookedEvents      WebhookEvent[]
  logs              WebhookLog[]
  queuedEvents      WebhookQueue[]

  @@index([userId])
  @@index([isActive])
  @@index([createdAt])
  @@index([authType])
}

model WebhookEvent {
  id          String   @id @default(uuid())
  webhookId   String
  eventType   String   // e.g., 'payment.success', 'bill.created', 'payment.failed'
  payload     Json     // Event data
  deliveryUrl String   // The URL this event was sent to
  status      String   @default("PENDING") // PENDING, DELIVERED, FAILED
  attempts    Int      @default(0)
  lastAttempt DateTime?
  nextRetry   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  webhook     Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  deliveryAttempts WebhookAttempt[]

  @@index([webhookId])
  @@index([status])
  @@index([eventType])
  @@index([createdAt])
}

model WebhookAttempt {
  id         String   @id @default(uuid())
  eventId    String
  statusCode Int?
  response   String?  // Response body from the webhook endpoint
  error      String?  // Error message if delivery failed
  duration   Int?     // Response time in milliseconds
  createdAt  DateTime @default(now())
  
  event      WebhookEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([createdAt])
}

model WebhookLog {
  id          String   @id @default(uuid())
  webhookId   String
  action      String   // e.g., 'CREATED', 'UPDATED', 'DELETED', 'TRIGGERED', 'FAILED'
  details     String?
  status      String   // SUCCESS, FAILURE, WARNING
  createdAt   DateTime @default(now())
  
  webhook     Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
}

model WebhookQueue {
  id              String   @id @default(uuid())
  webhookId       String
  eventType       String
  payload         Json
  priority        String   @default("NORMAL") // LOW, NORMAL, HIGH, CRITICAL
  status          String   @default("QUEUED") // QUEUED, PROCESSING, DELIVERED, FAILED, CANCELLED
  scheduledFor    DateTime @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  attempts        Int      @default(0)
  maxRetries      Int      @default(3)
  retryDelay      Int      @default(60)
  timeoutSeconds  Int      @default(30)
  lastStatusCode  Int?
  lastError       String?
  totalDuration   Int?
  headers         Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  webhook         Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([priority])
  @@index([scheduledFor])
  @@index([createdAt])
}

model UserSession {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique
  refreshToken String?  @unique
  userAgent    String?
  ipAddress    String?
  isActive     Boolean  @default(true)
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  user         User     @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model UserProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  bio         String?
  location    String?
  website     String?
  timezone    String   @default("UTC")
  language    String   @default("en")
  currency    String   @default("USD")
  theme       String   @default("light") // 'light', 'dark', 'auto'
  preferences Json?    // User preferences as JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String   // 'LOGIN', 'LOGOUT', 'PASSWORD_CHANGE', 'ROLE_UPDATE', etc.
  resource  String?  // Resource affected (e.g., 'user', 'bill', 'payment')
  resourceId String? // ID of the resource affected
  metadata  Json?    // Additional context
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  
  user      User?    @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model CrossChainTransaction {
  id                        String            @id @default(uuid())
  fromNetwork              BlockchainNetwork
  toNetwork                BlockchainNetwork
  fromAddress              String
  toAddress                String
  amount                   String
  asset                    String
  status                   CrossChainStatus   @default(INITIATED)
  sourceTransactionHash    String?            // Source blockchain transaction hash
  destinationTransactionHash String?         // Destination blockchain transaction hash
  bridgeContract           String?            // Bridge contract address
  bridgeProvider           String?            // Name of bridge provider
  bridgeFee                Decimal?           @db.Decimal(10, 2) // Bridge fee
  slippageTolerance        Decimal?           @db.Decimal(5, 2) // Slippage tolerance percentage
  estimatedCompletion      DateTime?          // Estimated completion time
  sourceConfirmations      Int?               // Number of confirmations on source chain
  destinationConfirmations Int?               // Number of confirmations on destination chain
  errorMessage             String?            // Error message if failed
  metadata                 Json?              // Additional bridge-specific data
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt

  @@index([fromNetwork])
  @@index([toNetwork])
  @@index([fromAddress])
  @@index([toAddress])
  @@index([status])
  @@index([sourceTransactionHash])
  @@index([destinationTransactionHash])
  @@index([bridgeProvider])
  @@index([createdAt])
}

model BlockchainWallet {
  id            String            @id @default(uuid())
  userId        String            @unique
  network       BlockchainNetwork
  address       String            @unique
  publicKey     String?           // Public key for Stellar
  encryptedData String?           // Encrypted private key or seed
  walletType    String            // 'METAMASK', 'FREIGHTER', 'PRIVATE_KEY', etc.
  isActive      Boolean           @default(true)
  lastUsedAt    DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  user          User              @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([network])
  @@index([address])
  @@index([walletType])
  @@index([isActive])
}

model NetworkConfig {
  id              String            @id @default(uuid())
  network         BlockchainNetwork @unique
  name            String            // Display name (e.g., "Ethereum Mainnet")
  rpcUrl          String            // RPC endpoint URL
  testnetRpcUrl   String?           // Testnet RPC URL
  chainId         Int?              // Chain ID for EVM networks
  testnetChainId  Int?              // Testnet chain ID
  blockExplorer    String?           // Block explorer URL
  currency        String            // Native currency symbol
  decimals        Int               // Number of decimal places
  gasLimit        Int?              // Default gas limit
  minGasPrice     String?           // Minimum gas price
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([network])
  @@index([isActive])
}

// Fraud Detection Models
enum FraudRiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FraudDetectionStatus {
  PENDING
  REVIEW_REQUIRED
  APPROVED
  REJECTED
  CONFIRMED_FRAUD
  FALSE_POSITIVE
}

enum FraudType {
  ACCOUNT_TAKEOVER
  SYNTHETIC_IDENTITY
  CARD_TESTING
  VELOCITY_ATTACK
  COLLUSION
  MONEY_LAUNDERING
  UNUSUAL_PATTERN
  GEOGRAPHIC_ANOMALY
  DEVICE_ANOMALY
  BEHAVIORAL_ANOMALY
  AMOUNT_ANOMALY
  TIME_ANOMALY
}

model FraudCase {
  id                    String                @id @default(uuid())
  transactionId         String                @unique
  userId                String
  riskScore             Float
  riskLevel             FraudRiskLevel
  detectedFraudTypes     FraudType[]
  status                FraudDetectionStatus  @default(PENDING)
  reviewerId            String?
  reviewNotes           String?
  actualOutcome         String?               // 'fraud' | 'legitimate' | 'investigating'
  modelVersion          String
  features              Json                  // Transaction features as JSON
  detectionResult       Json                  // Full detection result as JSON
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  resolvedAt            DateTime?

  user                  User                  @relation(fields: [userId], references: [id])
  payment               Payment?              @relation(fields: [transactionId], references: [id])

  @@index([userId])
  @@index([transactionId])
  @@index([riskLevel])
  @@index([status])
  @@index([reviewerId])
  @@index([createdAt])
  @@index([resolvedAt])
}

model FraudAlert {
  id            String        @id @default(uuid())
  caseId        String
  transactionId String
  userId        String
  alertType     FraudType
  severity      FraudRiskLevel
  message       String
  details       Json?         // Additional alert details
  isAcknowledged Boolean       @default(false)
  acknowledgedBy String?
  acknowledgedAt DateTime?
  createdAt     DateTime      @default(now())

  @@index([caseId])
  @@index([transactionId])
  @@index([userId])
  @@index([alertType])
  @@index([severity])
  @@index([isAcknowledged])
  @@index([createdAt])
}

model ManualReviewWorkflow {
  id                    String   @id @default(uuid())
  caseId                String   @unique
  assignedTo            String?
  status                String   // 'pending' | 'in_progress' | 'completed' | 'escalated'
  priority              String   // 'low' | 'medium' | 'high' | 'critical'
  dueDate               DateTime?
  verifyUserIdentity    Boolean  @default(false)
  checkTransactionHistory Boolean @default(false)
  validateGeographicData Boolean @default(false)
  reviewDeviceInformation Boolean @default(false)
  analyzeBehavioralPatterns Boolean @default(false)
  contactUserIfNecessary Boolean @default(false)
  notes                 String[] @default([])
  attachments            String[] @default([])
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  completedAt           DateTime?

  @@index([caseId])
  @@index([assignedTo])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([createdAt])
}

model FraudPattern {
  id                String        @id @default(uuid())
  name              String
  description       String
  fraudType         FraudType
  pattern           String        // JSON pattern definition
  isActive          Boolean       @default(true)
  severity          FraudRiskLevel
  detectionRules    String[]      @default([])
  falsePositiveRate Float         @default(0.0)
  detectionRate     Float         @default(0.0)
  lastTriggered     DateTime?
  triggerCount      Int           @default(0)
  createdBy         String
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([fraudType])
  @@index([isActive])
  @@index([severity])
  @@index([lastTriggered])
  @@index([createdBy])
}

model MLTrainingData {
  id            String   @id @default(uuid())
  transactionId  String   @unique
  features       Json     // Transaction features as JSON
  isFraud        Boolean
  fraudType      FraudType?
  confidence     Float
  modelVersion   String
  dataSource     String   // 'manual_review' | 'chargeback' | 'user_report' | 'automated'
  createdAt      DateTime @default(now())

  @@index([transactionId])
  @@index([isFraud])
  @@index([fraudType])
  @@index([modelVersion])
  @@index([dataSource])
  @@index([createdAt])
}

model FraudBlacklist {
  id            String   @id @default(uuid())
  type          String   // 'address' | 'ip' | 'device' | 'user_agent'
  value         String   @unique
  reason        String
  isActive      Boolean  @default(true)
  addedBy       String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([type])
  @@index([isActive])
  @@index([addedBy])
  @@index([createdAt])
}